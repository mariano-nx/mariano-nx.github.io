<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title> Mina Demooo </title>
		<script type="text/javascript" charset="utf-8">
  (function (g, e, n, es, ys) {
    g['_genesysJs'] = e;
    g[e] = g[e] || function () {
      (g[e].q = g[e].q || []).push(arguments)
    };
    g[e].t = 1 * new Date();
    g[e].c = es;
    ys = document.createElement('script'); ys.async = 1; ys.src = n; ys.charset = 'utf-8'; document.head.appendChild(ys);
  })(window, 'Genesys', 'https://apps.mypurecloud.com/genesys-bootstrap/genesys.min.js', {
    environment: 'use1',
    deploymentId: '1250be9f-31f5-4095-ad48-1100e92ee949'
  });
	Genesys('subscribe', 'Conversations.opened', function (){

				Genesys("command", "Database.set", {
					messaging: {
						customAttributes: {
						firstName: 'Maki',
						lastName: 'Doe',
						email: 'user@hydroottawa.com',
						accountNumber: 1234567890,
						language: 'EN',
						url: window.location.href,
						utm_source: 'google',
						utm_medium: 'email',
						utm_campaign: 'get_in_touch',
						utm_term: 'connect_with_us',
						utm_content: 'chat_button',
						}
					}
				});
			});
			
				  Genesys("subscribe", "Messenger.ready", function() {
		  document.getElementById("custom-launcher").style.display = "block";
		  document.getElementById("transcript-btn").style.display = "block";
		}); 
			
	  function openMessenger() {
      Genesys("command", "Messenger.open");
    }
	let lastMsgId = ""; 
let idCaptured = false; 

Genesys("subscribe", "MessagingService.messagesReceived", function(data) {

    if (!idCaptured && data.messages && data.messages.length > 0) {
        
        lastMsgId = data.messages[data.messages.length - 1].id;
        idCaptured = true; 
        
        console.log("ID ", lastMsgId);
    }
});
	
function getTranscript() {

if (!idCaptured) {
        alert("please try again");
        return;
    }
    

    console.log("Pstart download", lastMsgId);

            const apiGatewayUrl = 'https://lon6l2voxsinnhpai3xxzsrvx40hwbfs.lambda-url.ca-central-1.on.aws/';

            fetch(apiGatewayUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },

                body: JSON.stringify({ msgId: lastMessageId })
            })
            .then(response => response.json())
            .then(result => {
                if(result.transcriptUrl) {
                    window.open(result.transcriptUrl, '_blank');
                } else {
                    alert("Transcript not yet geenrated.");
                }
            })
            .catch(err => console.error("Gre≈°ka:", err));
        }


			
		  </script>
	</head>
		<body>

		<br><button id="custom-launcher" onclick="openMessenger()"> <img src="icon.svg"> </button>
		<br><button id="transcript-btn" onclick="getTranscript()"> Transcript</button>
	<style>

#custom-launcher{
	background-color:transparent;
	border:none;
    position: fixed;
    bottom: 70px;
    right: 30px;
	height: 90px;
	width: 90px;
	cursor: pointer;
	display: none;
}

	</style>
	</body>
	
</html>
