<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title> Demo Callbaxk </title>
		
		<script type="text/javascript" charset="utf-8">
		//console.log(window);
		//var token = "";
		
		function start(){
			//getToken();
			listQueues();
		}
		
		//get token
		function getToken(){
			//https://10pa4oa5di.execute-api.ca-central-1.amazonaws.com/default/Genesys_Lab_Access_Token
			fetch('https://10pa4oa5di.execute-api.ca-central-1.amazonaws.com/default/Genesys_Lab_Access_Token')
			.then(function (resp){
				console.log(resp);
				return resp.json();
			}).then(function (data){
				console.log(data);
				token=data.accessToken;
				console.log(token);
			}).catch(function (error){
				console.log("Error: ", error);
			});
			
		
			
		}
		
	
		
		
		
		function createCallback(){
			var name = document.getElementById('fname').value;
			var phone = document.getElementById('phone').value;
			var queue_id = document.getElementById('queues').value;
			console.log(document.getElementById('fname').value);
			console.log(document.getElementById('phone').value);
			console.log(document.getElementById('queues').value);
			
			var callbackData = {
					routingData: {
						queueId: queue_id
					},
					scriptId: '29d5d6a0-6199-11e7-8dfd-3b02f841a302',
					callbackUserName: name,
					callbackNumbers: [
						phone
					],
					validateCallbackNumbers: true,
					data:{
						customer_name: name
					}
				};
			
			//get token
			fetch('https://10pa4oa5di.execute-api.ca-central-1.amazonaws.com/default/Genesys_Lab_Access_Token')
			.then(function (resp){
				console.log(resp);
				return resp.json();
			}).then(function (data){
				//console.log(data);
				//token=data.accessToken;
				//console.log(token);
				return data.accessToken;
			}).then(function (token){
				return fetch('https://q31c3yeol7.execute-api.ca-central-1.amazonaws.com/test/cors-proxy/https:///api/v2/conversations/callbacks',{
				method: 'post',
				headers:{
					'Content-Type':'application/json',
					'Authorization':'Bearer '+token
				},
				body: JSON.stringify(callbackData)
			});
			}).then(function (resp){
				return resp.json();
			}).then(function (data){
				console.log(data);
				
				
			}).catch(function (error){
				console.log("Error: ", error);
			});
		
			
			
		
		}
		
		function listQueues(){
			
		
			//get token
			fetch('https://10pa4oa5di.execute-api.ca-central-1.amazonaws.com/default/Genesys_Lab_Access_Token')
			.then(function (resp){
				console.log(resp);
				return resp.json();
			}).then(function (data){
				//console.log(data);
				//token=data.accessToken;
				//console.log(token);
				return data.accessToken;
			}).then(function (token){
				return fetch('https://q31c3yeol7.execute-api.ca-central-1.amazonaws.com/test/cors-proxy/https://api.mypurecloud.com/api/v2/routing/queues?pageSize=160',{
				method: 'get',
				headers:{
					'Content-Type':'application/json',
					'Authorization':'Bearer '+token
				}
			});
			}).then(function (resp){
				return resp.json();
			}).then(function (data){
				console.log(data.entities);
				var dropdown = document.getElementById('queues');
				let defaultOption = document.createElement('option');
				defaultOption.text = 'Select Queue';

				dropdown.add(defaultOption);
				dropdown.selectedIndex = 0;
				let option;
				for(let item of data.entities){
					//console.log(item);
				  option = document.createElement('option');
				  option.text = item.name;
				  option.value = item.id;
				  dropdown.add(option);
				}
				
			}).catch(function (error){
				console.log("Error: ", error);
			});
		
		}
		  window.onload = start;
		</script>
	</head>
	<body>
		<form name="callback_form" action="javascript:createCallback()">
		  <label for="fname">First name:</label><br>
		  <input type="text" id="fname" name="fname" required><br>
		  <label for="phone">Phone Number:</label><br>
		  <input type="text" id="phone" name="phone" required><br>
		  <label for="queues">Please select a queue:</label><br>
		  <select  id="queues" name="queues">
		  </select><br>
		  <input id="createCB" type="submit" value="Schedule Callback">
		</form>

	</body>
	<style>
		input:invalid {
		  border: 2px dashed red;
		}

		input:valid {
		  border: 2px solid green;
		}
	</style>
</html>